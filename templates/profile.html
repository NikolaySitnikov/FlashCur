<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Profile - Binance Dashboard</title>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800&display=swap"
        rel="stylesheet">
    <link rel="stylesheet" href="{{ url_for('static', filename='css/style.css') }}?v=7.7">
    <link rel="stylesheet" href="{{ url_for('static', filename='css/profile.css') }}?v=7.7">
</head>

<body>
    <div class="profile-page">
        <!-- Header -->
        <header class="profile-header">
            <div class="profile-header-content">
                <a href="{{ url_for('index') }}" class="back-link">
                    <span class="back-icon">←</span>
                    <span class="back-text">Back to Dashboard</span>
                </a>
            </div>
        </header>

        <!-- Main Content -->
        <div class="profile-container">
            <!-- Page Title -->
            <div class="profile-hero">
                <div class="user-avatar">
                    <span class="avatar-icon">👤</span>
                </div>
                <h1 class="profile-title">Account Settings</h1>
                <p class="profile-subtitle">{{ current_user.email }}</p>
            </div>

            <!-- Flash Messages -->
            {% with messages = get_flashed_messages(with_categories=true) %}
            {% if messages %}
            <div class="flash-messages">
                {% for category, message in messages %}
                <div class="flash-message flash-{{ category }}">
                    {{ message }}
                </div>
                {% endfor %}
            </div>
            {% endif %}
            {% endwith %}

            <div class="profile-grid">
                <!-- Account Information Card -->
                <div class="profile-card">
                    <h2 class="card-title">
                        <span class="title-icon">📊</span>
                        Account Information
                    </h2>

                    <div class="info-grid">
                        <div class="info-row">
                            <span class="info-label">
                                {% if '@wallet.local' in current_user.email %}
                                🔑 Wallet Address
                                {% else %}
                                📧 Email
                                {% endif %}
                            </span>
                            <span class="info-value">
                                {% if '@wallet.local' in current_user.email %}
                                <span class="wallet-address-display">
                                    {{ current_user.wallet_address[:6] }}...{{ current_user.wallet_address[-4:] }}
                                </span>
                                {% else %}
                                {{ current_user.email }}
                                {% endif %}
                            </span>
                        </div>

                        <div class="info-row">
                            <span class="info-label">Current Plan</span>
                            <span class="info-value">
                                <span class="user-tier tier-{{ current_user.tier }}">
                                    {{ current_user.tier_name }}
                                </span>
                            </span>
                        </div>

                        <div class="info-row">
                            <span class="info-label">Member Since</span>
                            <span class="info-value">{{ current_user.created_at.strftime('%B %d, %Y') }}</span>
                        </div>

                        <div class="info-row">
                            <span class="info-label">Account Status</span>
                            <span class="info-value status-active">
                                {% if current_user.is_active %}
                                ✅ Active
                                {% else %}
                                ❌ Inactive
                                {% endif %}
                            </span>
                        </div>

                        <div class="info-row">
                            <span class="info-label">Authentication</span>
                            <span class="info-value">
                                {% if '@wallet.local' in current_user.email %}
                                🔑 Wallet Only
                                {% elif current_user.wallet_address %}
                                🔐 Email + Wallet
                                {% else %}
                                📧 Email Only
                                {% endif %}
                            </span>
                        </div>
                    </div>

                    <div class="card-actions">
                        <a href="{{ url_for('pricing') }}" class="action-btn primary">
                            <span class="btn-icon">💎</span>
                            {% if current_user.tier == 0 %}
                            Upgrade to Pro
                            {% elif current_user.tier == 1 %}
                            Upgrade to Elite
                            {% else %}
                            View Pricing
                            {% endif %}
                        </a>

                        {% if current_user.is_paid_tier %}
                        <a href="{{ url_for('settings.settings') }}" class="action-btn secondary">
                            <span class="btn-icon">⚙️</span>
                            Settings
                        </a>
                        {% endif %}
                    </div>
                </div>

                <!-- Current Plan Features -->
                <div class="profile-card">
                    <h2 class="card-title">
                        <span class="title-icon">✨</span>
                        Your {{ current_user.tier_name }} Plan Features
                    </h2>

                    <div class="features-list">
                        {% if current_user.tier == 0 %}
                        <div class="feature-row">
                            <span class="feature-icon">🔄</span>
                            <span class="feature-text">Auto-refresh every <strong>15 minutes</strong></span>
                        </div>
                        <div class="feature-row">
                            <span class="feature-icon">🚨</span>
                            <span class="feature-text">Last <strong>10 volume alerts</strong></span>
                        </div>
                        <div class="feature-row">
                            <span class="feature-icon">📊</span>
                            <span class="feature-text">Top <strong>50 assets</strong> by volume</span>
                        </div>
                        <div class="feature-row">
                            <span class="feature-icon">📥</span>
                            <span class="feature-text">Watchlist export (top 50)</span>
                        </div>
                        {% elif current_user.tier == 1 %}
                        <div class="feature-row">
                            <span class="feature-icon">⚡</span>
                            <span class="feature-text">Auto-refresh every <strong>5 minutes</strong></span>
                        </div>
                        <div class="feature-row">
                            <span class="feature-icon">🚨</span>
                            <span class="feature-text">Last <strong>30 volume alerts</strong></span>
                        </div>
                        <div class="feature-row">
                            <span class="feature-icon">📊</span>
                            <span class="feature-text"><strong>Unlimited</strong> assets</span>
                        </div>
                        <div class="feature-row">
                            <span class="feature-icon">📧</span>
                            <span class="feature-text">Email notifications</span>
                        </div>
                        <div class="feature-row">
                            <span class="feature-icon">📥</span>
                            <span class="feature-text">CSV/JSON export</span>
                        </div>
                        <div class="feature-row">
                            <span class="feature-icon">🚫</span>
                            <span class="feature-text">Ad-free experience</span>
                        </div>
                        {% else %}
                        <div class="feature-row">
                            <span class="feature-icon">⚡</span>
                            <span class="feature-text">Real-time updates (<strong>30 seconds</strong>)</span>
                        </div>
                        <div class="feature-row">
                            <span class="feature-icon">♾️</span>
                            <span class="feature-text"><strong>Unlimited</strong> alert history</span>
                        </div>
                        <div class="feature-row">
                            <span class="feature-icon">📱</span>
                            <span class="feature-text">SMS + Telegram + Discord alerts</span>
                        </div>
                        <div class="feature-row">
                            <span class="feature-icon">📈</span>
                            <span class="feature-text">Historical data & charts</span>
                        </div>
                        <div class="feature-row">
                            <span class="feature-icon">🔌</span>
                            <span class="feature-text">API access</span>
                        </div>
                        <div class="feature-row">
                            <span class="feature-icon">🎫</span>
                            <span class="feature-text">Priority support</span>
                        </div>
                        {% endif %}
                    </div>

                    {% if current_user.tier < 2 %} <div class="upgrade-hint">
                        <a href="{{ url_for('pricing') }}" class="hint-text upgrade-link">
                            {% if current_user.tier == 0 %}
                            🚀 Upgrade to Pro for faster refresh, email alerts, and more!
                            {% else %}
                            👑 Upgrade to Elite for real-time updates and advanced features!
                            {% endif %}
                        </a>
                </div>
                {% endif %}
            </div>

            <!-- Change Password Card -->
            <div class="profile-card">
                <h2 class="card-title">
                    <span class="title-icon">🔒</span>
                    Change Password
                </h2>

                <form method="POST" action="{{ url_for('change_password') }}" class="profile-form">
                    <div class="form-group">
                        <label for="current_password" class="form-label">Current Password</label>
                        <input type="password" id="current_password" name="current_password" class="form-input"
                            placeholder="••••••••" required>
                    </div>

                    <div class="form-group">
                        <label for="new_password" class="form-label">New Password</label>
                        <input type="password" id="new_password" name="new_password" class="form-input"
                            placeholder="••••••••" minlength="8" required>
                        <p class="form-hint">Minimum 8 characters</p>
                    </div>

                    <div class="form-group">
                        <label for="confirm_password" class="form-label">Confirm New Password</label>
                        <input type="password" id="confirm_password" name="confirm_password" class="form-input"
                            placeholder="••••••••" minlength="8" required>
                    </div>

                    <button type="submit" class="action-btn primary">
                        <span class="btn-icon">💾</span>
                        Update Password
                    </button>
                </form>
            </div>


            <!-- Wallet Management Card -->
            <div class="profile-card">
                <h2 class="card-title">
                    <span class="title-icon">🔑</span>
                    Wallet Authentication
                </h2>

                {% if current_user.wallet_address %}
                <!-- Wallet is linked -->
                <div class="wallet-info">
                    <div class="info-row">
                        <span class="info-label">Linked Wallet</span>
                        <span class="info-value wallet-address">
                            <span class="wallet-short">{{ current_user.wallet_address[:6] }}...{{
                                current_user.wallet_address[-4:] }}</span>
                            <button class="copy-btn" onclick="copyWalletAddress('{{ current_user.wallet_address }}')">
                                📋
                            </button>
                        </span>
                    </div>

                    <p class="form-hint">
                        ✅ You can sign in with your wallet without needing a password.
                    </p>

                    {% if '@wallet.local' not in current_user.email %}
                    <button onclick="unlinkWallet()" class="action-btn danger" id="unlinkWalletBtn">
                        <span class="btn-icon">🔓</span>
                        Unlink Wallet
                    </button>
                    {% else %}
                    <p class="warning-text">
                        ⚠️ This is a wallet-only account. Set an email and password before unlinking your wallet.
                    </p>
                    {% endif %}
                </div>
                {% else %}
                <!-- Wallet not linked -->
                <div class="wallet-info">
                    <p class="form-hint">
                        Link your crypto wallet (MetaMask) to enable password-less sign-in.
                    </p>

                    <button onclick="linkWallet()" class="action-btn primary" id="linkWalletBtn">
                        <span class="btn-icon">🦊</span>
                        Connect Wallet
                    </button>
                </div>
                {% endif %}

                <!-- Wallet Status Message -->
                <div id="walletProfileStatus" class="wallet-status" style="display: none;"></div>
            </div>
        </div>

        <!-- Danger Zone (for future: delete account) -->
        <div class="danger-zone">
            <h2 class="danger-title">⚠️ Danger Zone</h2>
            <p class="danger-text">
                Need to delete your account or have issues?
                <a href="mailto:support@binancedashboard.com" class="danger-link">Contact Support</a>
            </p>
        </div>
    </div>
    </div>

    <script>
        // Dark mode only - no theme toggle needed

        // Password match validation
        document.getElementById('confirm_password').addEventListener('input', function () {
            const newPassword = document.getElementById('new_password').value;
            const confirm = this.value;

            if (confirm && newPassword !== confirm) {
                this.setCustomValidity('Passwords do not match');
            } else {
                this.setCustomValidity('');
            }
        });

        // Auto-hide flash messages after 5 seconds
        document.addEventListener('DOMContentLoaded', () => {
            const flashMessages = document.querySelectorAll('.flash-message');
            flashMessages.forEach(message => {
                setTimeout(() => {
                    message.style.animation = 'slideOutRight 0.5s ease forwards';
                    setTimeout(() => message.remove(), 500);
                }, 5000);
            });
        });

        // ═══════════════════════════════════════════════════════════════════════
        // WALLET MANAGEMENT FUNCTIONS
        // ═══════════════════════════════════════════════════════════════════════

        // Copy wallet address to clipboard
        function copyWalletAddress(address) {
            navigator.clipboard.writeText(address).then(() => {
                showProfileWalletStatus('📋 Address copied to clipboard!', 'success');
            }).catch(() => {
                showProfileWalletStatus('❌ Failed to copy address', 'error');
            });
        }

        // Show wallet status message in profile
        function showProfileWalletStatus(message, type = 'info') {
            const statusDiv = document.getElementById('walletProfileStatus');
            statusDiv.style.display = 'block';
            statusDiv.className = `wallet-status wallet-status-${type}`;
            statusDiv.textContent = message;

            // Auto-hide after 5 seconds (except for errors)
            if (type !== 'error') {
                setTimeout(() => {
                    statusDiv.style.display = 'none';
                }, 5000);
            }
        }

        // Link wallet to current account
        async function linkWallet() {
            const isMobile = /Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent);

            // Check if MetaMask is installed
            if (typeof window.ethereum === 'undefined') {
                if (isMobile) {
                    showProfileWalletStatus('❌ MetaMask app not detected. Please install MetaMask mobile app.', 'error');
                } else {
                    showProfileWalletStatus('❌ MetaMask not detected. Please install MetaMask extension.', 'error');
                }
                window.open('https://metamask.io/download/', '_blank');
                return;
            }

            const btn = document.getElementById('linkWalletBtn');
            const originalText = btn.innerHTML;

            try {
                btn.disabled = true;
                btn.innerHTML = '<span class="btn-icon">⏳</span> Connecting...';
                showProfileWalletStatus('🔐 Requesting wallet connection...', 'info');

                // Request account access
                const accounts = await window.ethereum.request({
                    method: 'eth_requestAccounts'
                });

                const address = accounts[0];

                if (!address) {
                    throw new Error('No account selected');
                }

                // Step 1: Request nonce
                showProfileWalletStatus('🔑 Requesting authentication challenge...', 'info');

                const nonceResponse = await fetch('/wallet/request-nonce', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ address })
                });

                if (!nonceResponse.ok) {
                    const error = await nonceResponse.json();
                    throw new Error(error.error || 'Failed to request nonce');
                }

                const nonceData = await nonceResponse.json();

                if (!nonceData.success) {
                    throw new Error(nonceData.error || 'Failed to get nonce');
                }

                // Step 2: Sign message
                showProfileWalletStatus('✍️ Please sign the message in MetaMask...', 'info');

                const signature = await window.ethereum.request({
                    method: 'personal_sign',
                    params: [nonceData.message, address]
                });

                // Step 3: Link wallet
                showProfileWalletStatus('🔐 Linking wallet to your account...', 'info');

                const linkResponse = await fetch('/wallet/link-wallet', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ address, signature })
                });

                if (!linkResponse.ok) {
                    const error = await linkResponse.json();
                    throw new Error(error.error || 'Failed to link wallet');
                }

                const linkData = await linkResponse.json();

                if (!linkData.success) {
                    throw new Error(linkData.error || 'Failed to link wallet');
                }

                // Success! Reload page to show linked wallet
                showProfileWalletStatus('✅ Wallet linked successfully! Reloading...', 'success');
                setTimeout(() => {
                    window.location.reload();
                }, 1500);

            } catch (error) {
                console.error('Wallet link error:', error);

                if (error.code === 4001) {
                    showProfileWalletStatus('❌ Wallet connection rejected', 'error');
                } else if (error.message.includes('User denied')) {
                    showProfileWalletStatus('❌ Signature request rejected', 'error');
                } else {
                    showProfileWalletStatus(`❌ ${error.message}`, 'error');
                }

                btn.disabled = false;
                btn.innerHTML = originalText;
            }
        }

        // Unlink wallet from current account
        async function unlinkWallet() {
            if (!confirm('Are you sure you want to unlink your wallet? You will still be able to sign in with your email and password.')) {
                return;
            }

            const btn = document.getElementById('unlinkWalletBtn');
            const originalText = btn.innerHTML;

            try {
                btn.disabled = true;
                btn.innerHTML = '<span class="btn-icon">⏳</span> Unlinking...';
                showProfileWalletStatus('🔓 Unlinking wallet...', 'info');

                const response = await fetch('/wallet/unlink-wallet', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' }
                });

                if (!response.ok) {
                    const error = await response.json();
                    throw new Error(error.error || 'Failed to unlink wallet');
                }

                const data = await response.json();

                if (!data.success) {
                    throw new Error(data.error || 'Failed to unlink wallet');
                }

                // Success! Reload page
                showProfileWalletStatus('✅ Wallet unlinked successfully! Reloading...', 'success');
                setTimeout(() => {
                    window.location.reload();
                }, 1500);

            } catch (error) {
                console.error('Wallet unlink error:', error);
                showProfileWalletStatus(`❌ ${error.message}`, 'error');
                btn.disabled = false;
                btn.innerHTML = originalText;
            }
        }
    </script>
</body>

</html>